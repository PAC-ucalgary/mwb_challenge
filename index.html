<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Prevent indexing (add robots.txt in repo too) -->
  <meta name="robots" content="noindex, nofollow" />
  <title>MWB Volunteer Challenge – Live Leaderboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0f0d10;          /* page background */
      --bg-2:#1a161b;          /* card background */
      --brand:#b34445;         /* MWB maroon */
      --text:#e9e7ea;          /* primary text */
      --muted:#b5aebd;         /* secondary text */
      --gold:#d4af37;          /* 1st */
      --silver:#c0c0c0;        /* 2nd */
      --bronze:#cd7f32;        /* 3rd */
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --maxw:1120px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* Background: diagonal gradient + subtle dotted grid overlay */
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1500px 900px at 110% -10%, rgba(179,68,69,.35), rgba(179,68,69,0) 60%),
        radial-gradient(1000px 700px at -10% 110%, rgba(100,40,42,.35), rgba(100,40,42,0) 60%),
        linear-gradient(135deg, #0c0a0d, #141016 60%, #0b0a0c);
      background-attachment:fixed;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.12;
      background-image: radial-gradient(currentColor 1px, transparent 1px);
      background-size: 20px 20px; color:#c6b9c2;
    }

    a{color:var(--brand)}
    .wrap{max-width:var(--maxw); margin:0 auto; padding:28px 20px 56px}

    /* ===== HERO HEADER (centered) ===== */
    .hero-header{
      position:relative; padding:44px 20px 28px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(19,16,20,.85), rgba(19,16,20,.4));
      backdrop-filter: blur(6px) saturate(120%);
    }
    .hero-inner{ max-width:1000px; margin:0 auto; text-align:center }
    .mwb-logo{ height:68px; width:auto; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.35) }
    .title{ margin:10px 0 4px; font-size:28px; letter-spacing:.3px }
    .subtitle{ margin:0; opacity:.8 }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px }
    .btn{ appearance:none; border:0; padding:10px 14px; border-radius:14px; cursor:pointer;
          font-weight:700; letter-spacing:.2px; box-shadow:0 8px 20px rgba(0,0,0,.25); }
    .btn.primary{ background:linear-gradient(180deg, #c55355, #8b2d2e); color:#fff }
    .btn.outline{ background:transparent; color:var(--brand); border:1px solid rgba(179,68,69,.5) }
    .btn:focus-visible{ outline:2px solid var(--brand) }

    /* ===== CARDS with gradient edge ===== */
    .card{
      position:relative; background:var(--bg-2); border-radius:18px; padding:16px;
      box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06);
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius:18px; padding:1px; pointer-events:none;
      background:linear-gradient(180deg, rgba(179,68,69,.4), rgba(255,255,255,.06));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }
    .card h3{margin:0 0 12px; font-size:18px}
    .card small{color:var(--muted)}

    /* ===== GRID ===== */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:22px; margin-top:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* ===== TABLE ===== */
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{text-align:left; padding:10px 12px; font-size:14px}
    thead th{color:#d9d4de; font-weight:700; text-transform:uppercase; letter-spacing:.4px; font-size:12px}
    tbody tr{background:#151217; border:1px solid rgba(255,255,255,.06)}
    tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}

    .rank-badge{display:inline-block; min-width:28px; text-align:center; font-weight:800; padding:4px 8px; border-radius:8px}
    .rank-1{background:linear-gradient(180deg, var(--gold), #9a7d1d); color:#1b1504}
    .rank-2{background:linear-gradient(180deg, var(--silver), #8f8f8f); color:#0f1012}
    .rank-3{background:linear-gradient(180deg, var(--bronze), #8a4f1d); color:#160d07}

    .progress{ height:8px; background:#0f0d12; border-radius:999px; overflow:hidden; }
    .progress > span{ display:block; height:100%; background:linear-gradient(90deg, #b34445, #e07c7d); }

    /* ===== Podium for top 3 volunteers ===== */
    .podium{ display:flex; gap:14px; flex-wrap:wrap; margin-bottom:10px }
    .podium .p{ flex:1 1 180px; background:#151217; border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:12px; text-align:center }
    .medal{ display:inline-block; min-width:34px; padding:6px 10px; border-radius:999px; font-weight:800 }
    .medal.g{ background:linear-gradient(180deg, var(--gold), #9a7d1d); color:#1b1504 }
    .medal.s{ background:linear-gradient(180deg, var(--silver), #8f8f8f); color:#0f1012 }
    .medal.b{ background:linear-gradient(180deg, var(--bronze), #8a4f1d); color:#160d07 }

    .note{margin-top:10px; color:#d6d0dc}
    .warn{color:#ffd3d3}
    footer{margin-top:36px; color:var(--muted); text-align:center}
    .faint{opacity:.8}
    .hidden{display:none}
  </style>
</head>
<body>

  <!-- HERO HEADER -->
  <header class="hero-header">
    <div class="hero-inner">
      <img class="mwb-logo" src="assets/mwb-logo.png" alt="MWB logo" />
      <h1 class="title">MWB Volunteer Challenge</h1>
      <p class="subtitle">Live leaderboard • Updates every 60s</p>
      <div class="actions">
        <a class="btn outline" href="#info" id="openInfo">Challenge Info</a>
        <a class="btn primary" href="#yearly">Full Leaderboard</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="info" class="card" style="margin-top:18px">
      <h3>How It Works</h3>
      <p style="margin-top:8px; line-height:1.6">
        Form a team of 3–5 members and earn points by volunteering at MWB events like bake sales, bazaars, and annual dinners.
        Each member’s points contribute to the team total, which is averaged for fairness. Monthly winners take prizes, scores
        reset each month, and cumulative points determine the grand prize at year’s end. To qualify for rewards, each member must
        contribute at least 10% of their team’s total points.
      </p>
    </section>

    <div class="grid">
      <!-- Monthly Team Leaderboard -->
      <section id="monthlyTeams" class="card">
        <h3>Monthly Team Leaderboard <small id="monthLabel"></small></h3>
        <div id="monthlyTeamsError" class="hidden warn">Could not load team data. Please check the Google Sheet links.</div>
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th>Members</th>
              <th>Average Points</th>
            </tr>
          </thead>
          <tbody id="monthlyTeamsBody"></tbody>
        </table>
        <div class="note">A team’s average = total team points ÷ number of members.</div>
      </section>

      <!-- Top Volunteers (Monthly) -->
      <section id="topVolunteers" class="card">
        <h3>Top Volunteers <small id="monthLabel2"></small></h3>
        <div id="topVolsError" class="hidden warn">Could not load volunteer data. Please check the Google Sheet links.</div>

        <!-- Top-3 podium -->
        <div class="podium" id="podium"></div>

        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Team</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody id="topVolunteersBody"></tbody>
        </table>
      </section>
    </div>

    <!-- Yearly Overall Leaderboard -->
    <section id="yearly" class="card" style="margin-top:18px">
      <h3>Yearly Overall Standings</h3>
      <div id="yearlyError" class="hidden warn">Could not load yearly standings.</div>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Team</th>
            <th>Total Points (Year)</th>
          </tr>
        </thead>
        <tbody id="yearlyBody"></tbody>
      </table>
      <div class="note warn" style="margin-top:12px">Eligibility: To win prizes, each team member must contribute at least 10% of their team’s total points.</div>
    </section>

    <footer>
      <p>Built for MWB • Live data from Google Sheets • Auto-refreshes every minute</p>
    </footer>
  </main>

  <script>
    /* ============================
       CONFIG – Set your CSV links
       ============================ */
    // Publish each Google Sheet to the web (File → Share → Publish to web → CSV) and paste URLs below.
    const INDIVIDUAL_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=759346056&single=true&output=csv"; // columns: name, team, points (no date/month)
    const TEAM_CSV_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=0&single=true&output=csv"; // columns: team, members
    const YEARLY_CSV_URL     = ""; // optional: if set, used for Yearly standings

    // Optional: set the month label (display only). If empty, uses current month name.
    const FIXED_MONTH = ""; // format YYYY-MM

    /* ============================
       Utility helpers
       ============================ */
    const $ = (sel) => document.querySelector(sel);

    function thisMonthKey(){
      if (FIXED_MONTH) return FIXED_MONTH;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`; // YYYY-MM
    }

    function monthLabel(key){
      const [y,m] = key.split('-').map(Number);
      const date = new Date(y, m-1, 1);
      const fmt = new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'});
      return fmt.format(date);
    }

    // Basic CSV parser that handles quoted fields
    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while(i < text.length){
        const c = text[i];
        if(c==='"'){
          if(inQuotes && text[i+1]==='"'){ field+='"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if(c===',' && !inQuotes){ row.push(field); field=''; }
        else if((c==='\n' || c==='\r') && !inQuotes){ if(field!=='' || row.length){ row.push(field); rows.push(row); row=[]; field=''; } }
        else { field += c; }
        i++;
      }
      if(field!=='' || row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=>r.length && r.join('').trim()!=='');
    }

    async function fetchCSV(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const rows = parseCSV(text);
      const headers = rows[0].map(h=>h.trim().toLowerCase());
      const data = rows.slice(1).map(r=>{
        const obj={};
        headers.forEach((h,idx)=> obj[h] = (r[idx]||'').trim());
        return obj;
      });
      return data;
    }

    function number(n){
      const x = parseFloat(String(n).replace(/[^0-9.\-]/g,''));
      return isNaN(x)?0:x;
    }

    function renderRows(tbody, rows, rowRenderer){
      tbody.innerHTML = '';
      rows.forEach((obj, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = rowRenderer(obj, idx);
        tbody.appendChild(tr);
      });
    }

    function rankBadge(idx){
      const r = idx+1;
      const cls = r===1? 'rank-badge rank-1' : r===2? 'rank-badge rank-2' : r===3? 'rank-badge rank-3' : 'rank-badge';
      return `<span class="${cls}">${r}</span>`;
    }

    /* ============================
       Core Loading Logic
       ============================ */
    async function loadData(){
      const monthKey = thisMonthKey();
      // Labels (display only)
      $('#monthLabel').textContent = `• ${monthLabel(monthKey)}`;
      $('#monthLabel2').textContent = `• ${monthLabel(monthKey)}`;

      try {
        const [individuals, teams] = await Promise.all([
          fetchCSV(INDIVIDUAL_CSV_URL),
          fetchCSV(TEAM_CSV_URL)
        ]);

        // teamMembers: {TeamName: memberCount}
        const teamMembers = teams.reduce((acc,row)=>{
          const name = (row.team||row["team name"]||'').trim();
          const count = number(row.members || row.membercount || row["members"]);
          if(name) acc[name]=count||0; return acc;
        },{});

        // No month filtering: the Individuals CSV contains current month only
        const monthData = individuals;

        // ----- Monthly Teams (average + progress) -----
        const teamTotals = {};
        monthData.forEach(v=>{
          const team = (v.team||'').trim() || '—';
          teamTotals[team] = (teamTotals[team]||0) + number(v.points||v.score||v["pts"]);
        });

        const monthlyTeams = Object.entries(teamTotals).map(([team,total])=>{
          const members = teamMembers[team] || 0;
          const avg = members>0 ? total / members : 0;
          return {team, members, total, avg};
        }).sort((a,b)=> b.avg - a.avg);

        const maxAvg = monthlyTeams.length ? monthlyTeams[0].avg : 0;
        renderRows($('#monthlyTeamsBody'), monthlyTeams, (row, idx)=>{
          const pct = maxAvg ? Math.max(0, Math.min(100, (row.avg / maxAvg) * 100)) : 0;
          return `
            <td>${rankBadge(idx)}</td>
            <td>${row.team}</td>
            <td>${row.members}</td>
            <td>
              <strong>${row.avg.toFixed(2)}</strong>
              <div class="progress" style="margin-top:6px"><span style="width:${pct}%"></span></div>
            </td>
          `;
        });
        $('#monthlyTeamsError').classList.add('hidden');

        // ----- Top Volunteers (month) -----
        const volunteers = monthData.map(v=>({
          name:(v.name||v.volunteer||'').trim()||'—',
          team:(v.team||'').trim()||'—',
          points:number(v.points||v.score||v["pts"])
        })).sort((a,b)=> b.points - a.points).slice(0,20);

        // Podium (top 3)
        const podium = volunteers.slice(0,3);
        const medal = i => i===0?'g':i===1?'s':'b';
        $('#podium').innerHTML = podium.map((v,i)=>`
          <div class="p">
            <div class="medal ${medal(i)}">${i+1}</div>
            <div style="margin-top:8px; font-weight:800">${v.name}</div>
            <div style="opacity:.8">${v.team}</div>
            <div style="margin-top:6px; font-size:14px"><strong>${v.points}</strong> pts</div>
          </div>
        `).join('');

        renderRows($('#topVolunteersBody'), volunteers, (row, idx)=>`
          <td>${rankBadge(idx)}</td>
          <td>${row.name}</td>
          <td>${row.team}</td>
          <td><strong>${row.points}</strong></td>
        `);
        $('#topVolsError').classList.add('hidden');

        // ----- Yearly Overall by Team -----
        // If YEARLY_CSV_URL is provided, use that source; otherwise fall back to current sheet (will equal current month).
        let yearlySource = individuals;
        try {
          if (typeof YEARLY_CSV_URL !== 'undefined' && YEARLY_CSV_URL){
            yearlySource = await fetchCSV(YEARLY_CSV_URL);
          }
        } catch(e){ console.warn('Yearly CSV failed, falling back to current sheet'); }

        const yearlyTotals = yearlySource.reduce((acc,v)=>{
          const team=(v.team||'').trim()||'—';
          acc[team]=(acc[team]||0) + number(v.points||v.score||v['pts']);
          return acc;
        },{});
        const yearly = Object.entries(yearlyTotals).map(([team,total])=>({team,total}))
                        .sort((a,b)=> b.total - a.total);

        renderRows($('#yearlyBody'), yearly, (row, idx)=>`
          <td>${rankBadge(idx)}</td>
          <td>${row.team}</td>
          <td><strong>${row.total}</strong></td>
        `);
        $('#yearlyError').classList.add('hidden');

      } catch (err){
        console.error(err);
        $('#monthlyTeamsError').classList.remove('hidden');
        $('#topVolsError').classList.remove('hidden');
        $('#yearlyError').classList.remove('hidden');
      }
    }

    loadData();
    // Auto-refresh every 60s
    setInterval(loadData, 60_000);
  </script>
</body>
</html>
