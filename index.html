<script>
/* ====== 1) PUT YOUR CSV LINKS HERE ====== */
const TEAMS_CSV_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=0&single=true&output=csv";            // Teams tab
const MONTHLY_CSV_URL     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=1504587411&single=true&output=csv";   // Monthly Points tab
const INDIVIDUAL_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=759346056&single=true&output=csv";// Individual points tab
/* Optional: lock the page to a specific month label (e.g., "October 2025") */
// const FIXED_MONTH_LABEL = "October 2025";
const FIXED_MONTH_LABEL = "";

/* ====== Small helpers ====== */
const $ = (s)=>document.querySelector(s);
function number(n){ const x=parseFloat(String(n||"").replace(/[^0-9.\-]/g,'')); return isNaN(x)?0:x; }
function parseCSV(text){
  // CSV parser that keeps empty cells and handles quotes
  let rows=[], row=[], cell="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c === '"'){
      if(q && text[i+1]==='"'){ cell+='"'; i++; } else { q=!q; }
    }else if(c===',' && !q){ row.push(cell); cell=""; }
    else if((c==='\n'||c==='\r') && !q){ if(cell!==""||row.length){ row.push(cell); rows.push(row); row=[]; cell=""; } }
    else{ cell+=c; }
  }
  if(cell!==""||row.length){ row.push(cell); rows.push(row); }
  return rows;
}
async function fetchCSV(url){
  const res = await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const rows = parseCSV(await res.text());
  const headers = rows[0].map(h=>({raw:h.trim(), key:h.trim().toLowerCase()}));
  return rows.slice(1).map(r=>{
    const o={}; headers.forEach((h,i)=> o[h.key] = (r[i]||"").trim() );
    // Keep a copy of original cases too (useful for the Team name)
    o.__raw = {}; headers.forEach((h,i)=> o.__raw[h.raw] = (r[i]||"").trim() );
    return o;
  });
}

/* ====== Month label detection (matches your column headers) ====== */
function currentMonthLabel(){
  if(FIXED_MONTH_LABEL) return FIXED_MONTH_LABEL;
  const d = new Date();
  return new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'}).format(new Date(d.getFullYear(), d.getMonth(), 1));
}
function monthKeyLC(){ return currentMonthLabel().toLowerCase(); }

/* ====== Rendering helpers ====== */
function renderRows(tb, rows, tmpl){
  tb.innerHTML = "";
  rows.forEach((row, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = tmpl(row,i);
    tb.appendChild(tr);
  });
}
function rankBadge(i){
  const r=i+1;
  let c='rank-badge';
  if(r===1) c+=' rank-1';
  else if(r===2) c+=' rank-2';
  else if(r===3) c+=' rank-3';
  return `<span class="${c}">${r}</span>`;
}

/* ====== Main loader ====== */
async function load(){
  const mLabel = currentMonthLabel();
  $('#monthLabel').textContent  = '• ' + mLabel;
  $('#monthLabel2').textContent = '• ' + mLabel;

  try{
    // Fetch all three tabs
    const [teams, monthly, indiv] = await Promise.all([
      fetchCSV(TEAMS_CSV_URL),
      fetchCSV(MONTHLY_CSV_URL),
      fetchCSV(INDIVIDUAL_CSV_URL)
    ]);

    // --- Build (team -> members) map from Teams
    const teamMembers = teams.reduce((acc,row)=>{
      const name = (row['team']||row.__raw['team']||'').trim();
      acc[name] = number(row['members']||row.__raw['members']);
      return acc;
    }, {});

    // =====  A) Monthly Team Leaderboard (AVG = month points / members)
    const monthKey = monthKeyLC();              // e.g., "october 2025"
    const totalForYearKey = 'total for year';   // used later

    // Monthly Points tab already has totals per team by month
    const monthlyTeams = monthly.map(r=>{
      const team = (r['team']||r.__raw['Team']||'').trim();
      const pts  = number(r[monthKey]);               // the team's total for this month
      const mem  = teamMembers[team]||0;
      return {team, members:mem, avg: mem ? (pts/mem) : 0, totalMonth: pts};
    }).sort((a,b)=> b.avg - a.avg);

    const maxAvg = monthlyTeams.length ? monthlyTeams[0].avg : 0;
    renderRows($('#monthlyTeamsBody'), monthlyTeams, (r,i)=>{
      const pct = maxAvg ? Math.min(100, (r.avg/maxAvg)*100) : 0;
      return `
        <td>${rankBadge(i)}</td>
        <td>${r.team}</td>
        <td>${r.members}</td>
        <td>
          <strong>${r.avg.toFixed(2)}</strong>
          <div class="progress"><span style="width:${pct}%"></span></div>
        </td>`;
    });
    $('#monthlyTeamsError').classList.add('hidden');

    // =====  B) Top Volunteers (from Individual points for the same month)
    const topVols = indiv.map(r=>{
      return {
        name: (r['name']||r.__raw['Name']||'').trim(),
        team: (r['team']||r.__raw['Team']||'').trim(),
        points: number(r[monthKey])
      };
    }).sort((a,b)=> b.points - a.points).slice(0,20);

    // Podium
    const podium = topVols.slice(0,3);
    const medal  = i => i===0?'g':(i===1?'s':'b');
    $('#podium').innerHTML = podium.map((v,i)=>`
      <div class="p">
        <div class="medal ${medal(i)}">${i+1}</div>
        <div style="margin-top:6px;font-weight:700">${v.name}</div>
        <div style="opacity:.8">${v.team||'—'}</div>
        <div style="margin-top:4px;font-size:14px"><strong>${v.points}</strong> pts</div>
      </div>`).join('');
    renderRows($('#topVolunteersBody'), topVols, (r,i)=>`
      <td>${rankBadge(i)}</td><td>${r.name}</td><td>${r.team||'—'}</td><td><strong>${r.points}</strong></td>
    `);
    $('#topVolsError').classList.add('hidden');

    // =====  C) Yearly Overall (use "Total for Year" from Monthly Points)
    const yearly = monthly.map(r=>{
      const team  = (r['team']||r.__raw['Team']||'').trim();
      const total = number(r[totalForYearKey]);
      return {team, total};
    }).sort((a,b)=> b.total - a.total);

    renderRows($('#yearlyBody'), yearly, (r,i)=>`
      <td>${rankBadge(i)}</td><td>${r.team}</td><td><strong>${r.total}</strong></td>
    `);
    $('#yearlyError').classList.add('hidden');

  }catch(err){
    console.error(err);
    $('#monthlyTeamsError').classList.remove('hidden');
    $('#topVolsError').classList.remove('hidden');
    $('#yearlyError').classList.remove('hidden');
  }
}

load();
setInterval(load, 60000);
</script>
