<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>MWB Volunteer Challenge – Live Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#b34445; --brand-light:#f5eaea; --text:#2c2b2b; --muted:#666;
      --bg:#fdfcfb; --card:#ffffff; --shadow:0 2px 10px rgba(0,0,0,.08);
      --gold:#d4af37; --silver:#c0c0c0; --bronze:#cd7f32; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff;text-align:center;padding:32px 16px 24px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    /* Bigger, still responsive */
    header img{
      height:min(12vh,120px);   /* ~120px max, scales on small screens */
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
    }
        /* Invisible until you highlight it */
    .easter-egg{ color:var(--bg); }                           /* matches page background */
    .easter-egg::selection, .easter-egg::-moz-selection{ color:#111; }  /* turns dark when selected */

    header h1{margin:12px 0 4px;font-weight:800;font-size:28px}
    header p{margin:0;font-weight:500;opacity:.9}
    .actions{margin-top:14px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
    .btn{border:none;border-radius:8px;font-weight:600;cursor:pointer;padding:10px 16px}
    .btn.primary{background:#fff;color:var(--brand)}
    .btn.secondary{background:rgba(255,255,255,.15);color:white;border:1px solid rgba(255,255,255,.3)}
    main{max-width:1100px;margin:0 auto;padding:32px 20px 60px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:20px}
    .card h3{margin-top:0;font-size:20px;border-left:6px solid var(--brand);padding-left:10px}
    .note{color:var(--muted);margin-top:8px}
    .warn{color:#b11}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead th{text-align:left;font-size:13px;text-transform:uppercase;letter-spacing:.3px;color:var(--muted);border-bottom:2px solid #eee;padding-bottom:6px}
    td{padding:8px 4px;border-bottom:1px solid #f0f0f0}
    .rank-badge{display:inline-block;min-width:28px;text-align:center;font-weight:700;color:#fff;border-radius:6px;padding:4px 6px}
    .rank-1{background:var(--gold);color:#444}.rank-2{background:var(--silver);color:#333}.rank-3{background:var(--bronze)}
    .rank-badge:not(.rank-1):not(.rank-2):not(.rank-3){background:#ccc;color:#333}
    .progress{height:6px;background:#f1f1f1;border-radius:4px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--brand)}
    .podium{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .p{flex:1 1 160px;background:#f9f9f9;border-radius:10px;text-align:center;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .medal{font-weight:700;border-radius:999px;padding:6px 12px;display:inline-block}
    .medal.g{background:var(--gold);color:#333}.medal.s{background:var(--silver);color:#333}.medal.b{background:var(--bronze);color:#fff}
    footer{text-align:center;color:var(--muted);margin-top:30px;font-size:14px}
  </style>
</head>
<body>
<header>
  <img src="assets/mwb-logo.png" alt="MWB Logo">
  <h1>MWB Volunteer Challenge</h1>
  <p>Track your team's progress • Updated live every minute</p>
  <div class="actions">
    <button class="btn secondary" onclick="window.open('https://docs.google.com/document/d/10TXE9rau-aTRIjE-7C3XgmxFgihHCq1CJIonUrP7t1g/edit?usp=sharing', '_blank')">Challenge Info</button>
    <button class="btn primary" onclick="location='#yearly'">Full Leaderboard</button>
  </div>
</header>

<main>
  <section id="info" class="card">
    <h3>How It Works</h3>
    <p>Form a team of 3–5 members and earn points by volunteering at MWB events like bake sales, bazaars, and annual dinners.
    Each member’s points contribute to the team total, averaged for fairness. Monthly winners earn prizes (scores reset each month),
    and cumulative points determine grand prize winners. Each member must contribute at least 10% of their team’s total points to qualify.</p>
  </section>

  <div class="grid">
    <section id="monthlyTeams" class="card">
      <h3>Monthly Team Leaderboard <small id="monthLabel"></small></h3>
      <div id="monthlyTeamsError" class="warn hidden">Could not load team data.</div>
      <table>
        <thead>
          <tr><th>Rank</th><th>Team</th><th>Average Points</th></tr>
        </thead>
        <tbody id="monthlyTeamsBody"></tbody>
      </table>
      <p class="note">Team average = total points ÷ number of members</p>
    </section>

    <section id="topVolunteers" class="card">
      <h3>Top Volunteers <small id="monthLabel2"></small></h3>
      <div id="topVolsError" class="warn hidden">Could not load volunteer data.</div>
      <div class="podium" id="podium"></div>
      <table>
        <thead><tr><th>Rank</th><th>Name</th><th>Team</th><th>Points</th></tr></thead>
        <tbody id="topVolunteersBody"></tbody>
      </table>
    </section>
  </div>

  <section id="yearly" class="card">
    <h3>Yearly Overall Standings</h3>
    <div id="yearlyError" class="warn hidden">Could not load yearly standings.</div>
    <table>
      <thead><tr><th>Rank</th><th>Team</th><th>Total Points (Year)</th></tr></thead>
      <tbody id="yearlyBody"></tbody>
    </table>
    <p class="note">Each member must contribute ≥10% of team total to qualify for prizes.</p>
  </section>

<footer>
  © MWB • Live data from Google Sheets • Auto-refreshes every 60 seconds
  <span class="easter-egg"> • Inspired by PAC</span>
</footer>

</main>

<!-- All logic embedded here so the page is a single HTML file -->
<script>
/* ====== CSV LINKS (update to your published CSVs) ====== */
const TEAMS_CSV_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=0&single=true&output=csv";
const MONTHLY_CSV_URL     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=1504587411&single=true&output=csv";
const INDIVIDUAL_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQB94ZwTlKNFsY10SeVArbMcwC5BM3qkP1I2_er_WL6V657H1Aje4ZoidJSbAXRc21Zoxie2vdeGyek/pub?gid=759346056&single=true&output=csv";
const FIXED_MONTH_LABEL = ""; // e.g., "October 2025" if you want to lock the page

/* ====== Helpers ====== */
const $ = (s)=>document.querySelector(s);
function number(n){ const x=parseFloat(String(n||"").replace(/[^0-9.\-]/g,'')); return isNaN(x)?0:x; }
function parseCSV(text){
  let rows=[], row=[], cell="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c === '"'){ if(q && text[i+1]==='"'){ cell+='"'; i++; } else { q=!q; } }
    else if(c===',' && !q){ row.push(cell); cell=""; }
    else if((c==='\n'||c==='\r') && !q){ if(cell!==""||row.length){ row.push(cell); rows.push(row); row=[]; cell=""; } }
    else{ cell+=c; }
  }
  if(cell!==""||row.length){ row.push(cell); rows.push(row); }
  const headers = rows[0].map(h=>({raw:h.trim(), key:h.trim().toLowerCase()}));
  return rows.slice(1).map(r=>{
    const o={}; headers.forEach((h,i)=> o[h.key] = (r[i]||"").trim() );
    o.__raw={}; headers.forEach((h,i)=> o.__raw[h.raw] = (r[i]||"").trim() );
    return o;
  });
}
async function fetchCSV(url){ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error("HTTP "+res.status); return parseCSV(await res.text()); }
function currentMonthLabel(){ if(FIXED_MONTH_LABEL) return FIXED_MONTH_LABEL; const d=new Date(); return new Intl.DateTimeFormat(undefined,{month:'long',year:'numeric'}).format(new Date(d.getFullYear(),d.getMonth(),1)); }
function normalizeHeader(s){ return (s||"").toLowerCase().replace(/[^a-z0-9 ]+/g,"").replace(/\s+/g," ").trim(); }
function findMonthKeyInRow(rowObj){
  const want=normalizeHeader(currentMonthLabel());
  for(const k of Object.keys(rowObj)){ if(k==="__raw") continue; if(normalizeHeader(k)===want) return k; }
  if(rowObj.__raw){ for(const k of Object.keys(rowObj.__raw)){ if(normalizeHeader(k)===want) return k; } }
  return null;
}
function renderRows(tb, rows, tmpl){ tb.innerHTML=""; rows.forEach((row,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=tmpl(row,i); tb.appendChild(tr); }); }
function rankBadge(i){ const r=i+1; let c='rank-badge'; if(r===1)c+=' rank-1'; else if(r===2)c+=' rank-2'; else if(r===3)c+=' rank-3'; return `<span class="${c}">${r}</span>`; }

/* ====== Main loader ====== */
async function load(){
  const mLabel=currentMonthLabel();
  $('#monthLabel').textContent='• '+mLabel;
  $('#monthLabel2').textContent='• '+mLabel;

  try{
    const [teams, monthly, indiv]=await Promise.all([ fetchCSV(TEAMS_CSV_URL), fetchCSV(MONTHLY_CSV_URL), fetchCSV(INDIVIDUAL_CSV_URL) ]);

    // Map: team -> members
    const teamMembers=teams.reduce((acc,row)=>{
      const name=(row['team']||row.__raw['team']||row.__raw['Team']||'').trim();
      acc[name]=number(row['members']||row.__raw['members']||row.__raw['Members']);
      return acc;
    },{});

    // ===== A) Monthly Team Leaderboard (skip "No Team", hide members)
    const monthlyTeams = monthly
      .map(r=>{
        const team=(r['team']||r.__raw['Team']||'').trim();
        if(!team || team.toLowerCase()==='no team') return null;         // <-- remove No Team
        const mk=findMonthKeyInRow(r);
        const pts=number(mk ? (r[mk] ?? r.__raw?.[mk]) : 0);
        const mem=teamMembers[team]||0;
        return {team, avg: mem ? (pts/mem) : 0};
      })
      .filter(Boolean)
      .sort((a,b)=> b.avg - a.avg);

    const maxAvg=monthlyTeams.length ? monthlyTeams[0].avg : 0;
    renderRows($('#monthlyTeamsBody'), monthlyTeams, (r,i)=>{
      const pct=maxAvg ? Math.min(100,(r.avg/maxAvg)*100) : 0;
      return `
        <td>${rankBadge(i)}</td>
        <td>${r.team}</td>
        <td>
          <strong>${r.avg.toFixed(2)}</strong>
          <div class="progress"><span style="width:${pct}%"></span></div>
        </td>`;
    });
    $('#monthlyTeamsError').classList.add('hidden');

    // ===== B) Top Volunteers
    const topVols=indiv.map(r=>{
      const mk=findMonthKeyInRow(r);
      return {
        name:(r['name']||r.__raw['Name']||'').trim(),
        team:(r['team']||r.__raw['Team']||'').trim(),
        points:number(mk ? (r[mk] ?? r.__raw?.[mk]) : 0)
      };
    }).sort((a,b)=> b.points-a.points).slice(0,20);

    const podium=topVols.slice(0,3); const medal=i=>i===0?'g':(i===1?'s':'b');
    $('#podium').innerHTML=podium.map((v,i)=>`
      <div class="p">
        <div class="medal ${medal(i)}">${i+1}</div>
        <div style="margin-top:6px;font-weight:700">${v.name}</div>
        <div style="opacity:.8">${v.team||'—'}</div>
        <div style="margin-top:4px;font-size:14px"><strong>${v.points}</strong> pts</div>
      </div>`).join('');
    renderRows($('#topVolunteersBody'), topVols, (r,i)=>`
      <td>${rankBadge(i)}</td><td>${r.name}</td><td>${r.team||'—'}</td><td><strong>${r.points}</strong></td>
    `);
    $('#topVolsError').classList.add('hidden');

    // ===== C) Yearly Overall (unchanged)
    const yearly=monthly.map(r=>{
      const team=(r['team']||r.__raw['Team']||'').trim();
      const total=number(r['total for year'] ?? r.__raw?.['Total for Year']);
      return {team,total};
    }).sort((a,b)=> b.total-a.total);

    renderRows($('#yearlyBody'), yearly, (r,i)=>`
      <td>${rankBadge(i)}</td><td>${r.team}</td><td><strong>${r.total}</strong></td>
    `);
    $('#yearlyError').classList.add('hidden');

  }catch(err){
    console.error(err);
    $('#monthlyTeamsError').classList.remove('hidden');
    $('#topVolsError').classList.remove('hidden');
    $('#yearlyError').classList.remove('hidden');
  }
}
load();
setInterval(load,60000);
</script>
</body>
</html>
